<script src="nearestColor.js"></script>
<script>
    function each(arr, func) {
      var i;
      for (i = 0; i < arr.length; i++) {
        func(arr[i]);
      }
    }

    function range(lo, hi) {
      let range = [];
      var i;
      for (i = lo; i < hi; i++) {
        range.push(i);
      }
      return range;
    }

    function bashColor(px) {
      var pxColor = rgbToHex({r: px[0], g: px[1], b: px[2]});
      var foundColor = nearestColor.BASH_MAP[nearestColor(pxColor)];
      return foundColor;
    }

    function download(data, filename, type) {
      var file = new Blob([data], {type: type});
      if (window.navigator.msSaveOrOpenBlob) // IE10+
          window.navigator.msSaveOrOpenBlob(file, filename);
      else { // Others
          var a = document.createElement("a"),
                  url = URL.createObjectURL(file);
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          setTimeout(function() {
              document.body.removeChild(a);
              window.URL.revokeObjectURL(url);
          }, 0);
      }
    }

    var varNames = ['x', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r',
    's', 't', 'u', 'v', 'w', 'y', 'z', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L',
    'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', 'a1', 'a2', 'a3', 'a4', 'a5',
    'a6', 'a7', 'a8', 'a9', 'a0', 'a10', 'a11', 'a12', 'a13', 'a14', 'a15', 'a16', 'a17', 'a18', 'a19', 'a20', 'a21',
    'a22', 'a23', 'a24', 'a25', 'a26', 'a27', 'a28', 'a29', '30', '31', '32', '33', '34', '35', '36', '37',
    '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53',
    '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69',
    '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85',
    '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99', 'a100', 'a101',
    'a102', 'a103', 'a104', 'a105', 'a106', 'a107', 'a108', 'a109', 'a110', 'a111', 'a112', 'a113', 'a114', 'a115',
    'a116', 'a117', 'a118', 'a119', 'a120', 'a121', 'a122', 'a123', 'a124', 'a125', 'a126', 'a127', 'a128', 'a129',
    'a130', 'a131', 'a132', 'a133', 'a134', 'a135', 'a136', 'a137', 'a138', 'a139', 'a140', 'a141', 'a142', 'a143',
    'a144', 'a145', 'a146', 'a147', 'a148', 'a149', 'a150', 'a151', 'a152', 'a153', 'a154', 'a155', 'a156', 'a157',
    'a158', 'a159', 'a160', 'a161', 'a162', 'a163', 'a164', 'a165', 'a166', 'a167', 'a168', 'a169', 'a170', 'a171',
    'a172', 'a173', 'a174', 'a175', 'a176', 'a177', 'a178', 'a179', 'a180', 'a181', 'a182', 'a183', 'a184', 'a185',
    'a186', 'a187', 'a188', 'a189', 'a190', 'a191', 'a192', 'a193', 'a194', 'a195', 'a196', 'a197', 'a198', 'a199',
    'a200', 'a201', 'a202', 'a203', 'a204', 'a205', 'a206', 'a207', 'a208', 'a209', 'a210', 'a211', 'a212', 'a213',
    'a214', 'a215', 'a216', 'a217', 'a218', 'a219', 'a220', 'a221', 'a222', 'a223', 'a224', 'a225', 'a226', 'a227',
    'a228', 'a229'];
    var colorCount = 0;
    var varMap = {};

    function test() {
        var file = document.getElementById('file').files[0];
        var reader  = new FileReader();
        reader.onload = function(e)  {
            // var image = document.createElement("img");
            // image.src = e.target.result;
            // image.id = 'the-img';
            //document.body.appendChild(image);
            var img = new Image();
            img.src = e.target.result; //document.getElementById('the-img');
            img.onload = function() {
              var canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              var ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, img.width, img.height);

              //set background color to 1st pixel found
              var cowFileVars = '$' + varNames[0] + ' = "\\e[m  ";          #reset color\n';
              var cowFile = '';
              var bgColor = bashColor(ctx.getImageData(0, 0, 1, 1).data);
              varMap[bgColor] = varNames[0];
              colorCount++;
              var lastColor = bgColor;

              each(range(0, img.height), y => {
                each(range(0, img.width), x => {
                  var px = ctx.getImageData(x, y, 1, 1).data;
                  var foundColor = bashColor(px);
                  if (foundColor !== lastColor) {
                    lastColor = foundColor;
                    let varName = varMap[foundColor];
                    if (!varName) {
                      varName = varNames[colorCount];
                      colorCount++;
                      varMap[foundColor] = varName;
                      cowFileVars += '$' + varName + ' = "\\e[48;5;' + foundColor + 'm  ";\n';
                    }
                    cowFile += '$' + varName;
                  } else {
                    cowFile += '  ';
                  }
                });
                cowFile += '\n';
              });

              var outFile = cowFileVars + '\n$the_cow = <<EOC\n\n' + cowFile + '\nEOC\n';
              download(outFile, 'generated.cow', 'text');
            }
         }
         reader.readAsDataURL(file);

     }
</script>
<head><title>charc0al's cowsay file generator</title></head>
<body>
    <h1>Charc0al's cowsay file generator</h1>
    <input type=file name=filename id=file>
    <button type=button onclick='test()'>Convert</button></br>
</body>
